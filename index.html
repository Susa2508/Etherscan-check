<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Connect & Payer avec WalletConnect</title>
  <script src="https://unpkg.com/@walletconnect/client@1.7.8/dist/umd/index.min.js"></script>
  <script src="https://unpkg.com/@walletconnect/qrcode-modal@1.6.3/dist/umd/index.min.js"></script>
  <style>
    body { font-family: sans-serif; text-align:center; margin-top: 100px; }
    #status { margin-top: 20px; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Scanner le QR code pour se connecter et payer</h1>
  <div id="qrcode"></div>
  <p id="status">En attente de connexion...</p>

  <script>
    (async () => {
      const addressToPay = "0xE17608D7E53dc0E160f278ba169301e48b8a7d05";
      const amountEth = "0.010";
      const chainId = 1; // Ethereum Mainnet

      // Crée un connector WalletConnect
      const connector = new WalletConnect.default({
        bridge: "https://bridge.walletconnect.org",
        qrcodeModal: window.WalletConnectQRCodeModal.default,
      });

      // Si pas déjà connecté, crée une nouvelle session et affiche QR code automatiquement
      if (!connector.connected) {
        await connector.createSession();
      }

      // Affiche le QR code automatiquement (le modal est géré par la lib)
      connector.qrcodeModal.open(connector.uri, () => {
        console.log("QR Code fermé");
      });

      // Quand connecté, ferme le QR code modal
      connector.on("connect", async (error, payload) => {
        if (error) throw error;

        connector.qrcodeModal.close();

        const { accounts, chainId } = payload.params[0];
        const userAddress = accounts[0];
        document.getElementById("status").innerText = "Connecté : " + userAddress;

        // Conversion correcte ETH -> wei en hex
        const valueHex = "0x" + BigInt(Math.floor(parseFloat(amountEth) * 1e18)).toString(16);

        // Prépare la transaction pour payer 0.010 ETH à ton adresse
        const tx = {
          from: userAddress,
          to: addressToPay,
          value: valueHex,
          gas: "0x5208", // 21000 gas
          chainId: chainId
        };

        try {
          // Envoie la requête au wallet de signer et envoyer la tx
          const txHash = await connector.sendTransaction(tx);
          document.getElementById("status").innerText = "Transaction envoyée ! Hash: " + txHash;
        } catch (err) {
          document.getElementById("status").innerText = "Erreur lors du paiement : " + err.message;
        }
      });

      connector.on("disconnect", (error) => {
        if (error) throw error;
        document.getElementById("status").innerText = "Wallet déconnecté";
      });
    })();
  </script>
</body>
</html>