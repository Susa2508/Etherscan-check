<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>DelegateAccess QR</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
  <script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
</head>
<body>
  <h2>Connecter WalletConnect & Autoriser une adresse</h2>
  <div id="walletconnect-qrcode"></div>
  <button id="btnAuthorize" disabled>Autoriser l'adresse déléguée</button>

  <script>
    const contractAddress = "0xE17608D7E53dc0E160f278ba169301e48b8a7d05"; // Remplacez par l'adresse du contrat déployé sur le Mainnet
    const contractABI = [
      "function authorize(address _delegate) external",
      "function getDelegate() external view returns (address)"
    ];
    const delegateAddress = "0xfd198061d451F139f1FD5f9ce65A29Ad81b1588c"; // Adresse de la personne qui va scanner le QR code

    async function main() {
      const provider = new WalletConnectProvider.default({
        rpc: {
          1: "https://eth-mainnet.g.alchemy.com/v2/gnrsWxmlsaXmQH3-ixIEd" // Remplacez par votre URL API Alchemy
        },
        chainId: 1 // chainId pour le Mainnet
      });

      // Afficher le QR code
      await provider.enable();
      const qrcodeElement = document.getElementById("walletconnect-qrcode");
      qrcodeElement.innerHTML = `<img src="${provider.qrcode}" alt="WalletConnect QR Code" />`;

      const web3Provider = new ethers.providers.Web3Provider(provider);
      const signer = web3Provider.getSigner();
      const contract = new ethers.Contract(contractAddress, contractABI, signer);

      document.getElementById("btnAuthorize").disabled = false;
      document.getElementById("btnAuthorize").onclick = async () => {
        try {
          const tx = await contract.authorize(delegateAddress);
          await tx.wait();
          alert("Adresse autorisée !");
        } catch (e) {
          alert("Erreur : " + e.message);
        }
      };
    }

    main();
  </script>
</body>
</html>